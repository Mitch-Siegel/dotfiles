This is a duplication of [this reddit comment](https://www.reddit.com/r/VFIO/comments/j443ad/pass_through_a_partition/) in case link rot or account deletion results in the original post being lost.
Eventually, it will probably grow into a more comprehensive guide. My ultimate goal is not only to pass through an entire host drive partition to a VM, but to also to boot Windows from it.


## Reddit comment outlining partition passthrough

(Warning: do not do this without backups and a lot of care. If you aren't very comfortable with Linux and tools like dd you probably should not do this at all. I mention it only to pass on the knowledge that it is possible, even if it's usually a bad idea.)

For what it's worth, there is a way to pass through a single partition without having the VM treat it as a whole disk, but it's a massive kludge and not for the faint of heart. When I first set up VFIO I had a couple partitions I needed to share to the VM without passing the whole disk (due to Linux partitions on same disk) and figured out how to do it.

The trick is to use mdadm with the --level=linear switch to build a software raid from the real disk and a couple image files, which lets you pass this fake "disk" backed by a single real partition to the VM. The catch is you have to create two images, one to go before the partition and one to go after, and sandwich the real partition in the middle. The first partition needs enough space to hold the partition table, and I discovered the hard way that GPT format also needs a small amount of space at the end as well.

So you create the images with dd, turn them into mages with losetup, then mdadm --build /dev/md0 --chunk=$CHUNKSZ --level=linear --raid-devices=3 /path/to/left-pad /dev/real-disk /path/to/right-pad and you get a "real" disk to work with. (For chunk size I'd used 512, I forget if that was to match something on my real disk or just what I chose, YMMV.) Once that's done you can use normal disk partitioning tools to carefully add a partition table and create (but not format) a partition on this new partition table that matches the precise beginning and ending of the real partition on this fake disk. Once that's done you've got a "disk" you can pass to the VM that only contains the one real partition, leaving the rest of the physical disk to the host.

It's a bit hacky but it works; I've been using a disk set up this way for a few years now, and when I first set up VFIO I also briefly did it with a Windows boot partition to be able to use it for both dual-boot and VFIO. (This was a lot more work setting up a suitable fake disk than the data partition, however, needing a perfect recreation of the physical disk layout to make Windows not freak out.) I have a small shell script I run at boot that creates the loopback images with losetup and then runs mdam so that everything's ready to go before I start the VM.

Like I said at the start, though, this isn't for the faint of heart. You're building a fake disk by stitching together a mix of image files and part of a real disk and then attempting to create a new partition table that maps to this layout perfectly so that the partition exists with no data loss. One wrong number and you fucked up your data. Anyone that decides to try this is strongly encouraged to either work with an already empty partition or make a backup and be prepared to restore from it repeatedly during the trial-and-error phase. However if you're using an empty partition you're better off just passing through the partition as a full disk and letting the guest OS build a new partition table inside it, much less risky that way.
